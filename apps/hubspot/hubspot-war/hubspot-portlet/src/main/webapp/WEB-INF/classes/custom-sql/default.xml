<?xml version="1.0" encoding="UTF-8"?>

<custom-sql>
	<sql id="com.liferay.hubspot.util.database.DossieraDatabaseUtil.findOpportunityRenewals">
		<![CDATA[
			SELECT
				IFNULL(Account_.BillingCountryCode, 'US') AS countryCode,
				IFNULL(Contact_.Email, '[$HUBSPOT_RENEWAL_EMAIL_TEMPLATE$]') AS email,
				GROUP_CONCAT(
					CONCAT(DATE(Opportunity.Subscription_Start_Date__c), ': ', Account_.Name, ' (', IFNULL(Project__c.Name, Opportunity.Project__c), ')') SEPARATOR '<br/>'
				) AS opportunities
			FROM
				Opportunity
			INNER JOIN
				OpportunityContactRole ON
					Opportunity.Id_ = OpportunityContactRole.OpportunityId
			INNER JOIN
				Contact_ ON
					Contact_.Id_ = OpportunityContactRole.ContactId
			LEFT JOIN
				Account_ ON
					Account_.Id_ = Opportunity.AccountId
			LEFT JOIN
				Project__c ON
					Project__c.Id_ = Opportunity.Project__c
			WHERE
				NOT EXISTS
					(
						SELECT
							1
						FROM
							Task
						INNER JOIN
							User_ ON
								User_.Id_ = Task.OwnerId
						WHERE
							Contact_.OwnerId = Task.OwnerId AND
							Task.Subject = '[$HUBSPOT_RENEWAL_SUBJECT_TEMPLATE$]' AND
							User_.Id_ = '[$HUBSPOT_RENEWAL_USER_ID_TEMPLATE$]' AND
							TIMESTAMPDIFF(DAY, Task.ActivityDate, Now()) <= 31
						GROUP BY
							Task.WhoID
					) AND
				Account_.BillingCountryCode IN ([$HUBSPOT_RENEWAL_COUNTRY_CODES_TEMPLATE$]) AND
				Opportunity.Engaged_in_Renewal_Discussion__c = 'false' AND
				Opportunity.StageName = 'Uncommitted Renewal' AND
				Opportunity.Type_ = 'Renewal' AND
				OpportunityContactRole.IsPrimary = 'true' AND
				TIMESTAMPDIFF(DAY, DATE(Now()), DATE(Opportunity.Subscription_Start_Date__c)) IN ([$HUBSPOT_RENEWAL_DAYS_INTERVAL_TEMPLATE$])
			GROUP BY
				Account_.Id_, Contact_.Id_
			ORDER BY
				Contact_.Email
		]]>
	</sql>
</custom-sql>